<html>
  <head>
    <title>Man O&#39; War</title>

    <link type="text/css" rel="stylesheet" href="css/detail.css">
    <link type="text/css" rel="stylesheet" href="css/extensions.css">
    <link type="text/css" rel="stylesheet" href="css/graph.css">
    <link type="text/css" rel="stylesheet" href="css/legend.css">
    <link type="text/css" rel="stylesheet" href="css/jquery-ui.css">
    <link type="text/css" rel="stylesheet" href="css/jquery-ui-timepicker-addon.css">
    <link type="text/css" rel="stylesheet" href="css/manowar.css">

    <script src="js/d3.v2.js"></script>
    <script src="js/jquery-1.8.2.js"></script>
    <script src="js/jquery-ui-1.9.1.js"></script>
    <script src="js/jquery.sortable.js"></script>
    <!-- http://trentrichardson.com/examples/timepicker/ -->
    <script src="js/jquery-ui-timepicker-addon.js"></script>
    <script src="js/rickshaw.js"></script>

    <script type="text/javascript">
      //--- Globals.

      var graphs = [];
      var graphNum = 0;
      var dataCache = null; //Gets populated on first populate call.
      var mantaPrefix = null; //Gets populated on page load.
      var dataPath = '/stor/graphs/data/';
      var selectedGraph = null;
      var graphItButtonEnabled = false;



      //--- Muck with prototypes...

      if (typeof String.prototype.startsWith != 'function') {
              String.prototype.startsWith = function (str){
                      return (this.slice(0, str.length) === str);
              };
      }


      if (typeof String.prototype.endsWith != 'function') {
              String.prototype.endsWith = function(suffix) {
                      return (this.indexOf(suffix, this.length - suffix.length) !== -1);
              };
      }

      //Done mucking with prototypes.



      //--- Helpers

      //Janky coming...
      function stringToUTCDate(date) {
              var parts = date.split(' ');
              var ymd = parts[0].split('/');
              return (ymd[2] + '-' + ymd[0] + '-' + ymd[1] + 'T' +
                      parts[1] + ':00Z');
      }


      function getDateParts(ds) {
              var parts = ds.split('T');
              var dateParts = parts[0].split('-');
              var timeParts = parts[1].split(':');
              return ({
                      year: dateParts[0],
                      month: dateParts[1],
                      day: dateParts[2],
                      hour: timeParts[0],
              });
      }
      //End Janky,,,


      //http://stackoverflow.com/questions/647259/javascript-query-string
      function getQueryString() {
              var result = {}, queryString = location.search.substring(1),
              re = /([^&=]+)=([^&]*)/g, m;

              while (m = re.exec(queryString)) {
                      result[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
              }

              return result;
      }



      //--- Fun with events from the UI.

      function addLineFromPathChooser() {
              var path = document.querySelector('#path_chooser').value;
              var startDate = document.querySelector('#start_date').value;
              var endDate = document.querySelector('#end_date').value;

              //Turn start and end date into UTC...
              startDate = stringToUTCDate(startDate);
              endDate = stringToUTCDate(endDate);

              //TODO: Un hard-code this.
              var periodSeconds = 60;
              //Round the dates to the nearest periods to start fetching data...
              var startSeconds = new Date(startDate).getTime() / 1000;
              var endSeconds = new Date(endDate).getTime() / 1000;

              var graph = newGraph({
                      startSeconds: startSeconds,
                      endSeconds: endSeconds,
                      periodSeconds: periodSeconds
              });

              applyPathToGraph(graph, path);
      }


      //--- Fun with adding data to graphs.

      function newGraph(opts) {
              var startSeconds = opts.startSeconds;
              var periodSeconds = opts.periodSeconds;
              var numPoints = opts.numPoints;
              if (!numPoints || opts.endSeconds) {
                      var endSeconds = opts.endSeconds;
                      numPoints = (endSeconds - startSeconds) / periodSeconds;
              }

              //Just in case, rounding the seconds to our expectations
              startSeconds = startSeconds - (startSeconds % periodSeconds);
              endSeconds = endSeconds - (endSeconds % periodSeconds);

              return createEmptyGraph({
                      startSeconds: startSeconds,
                      periodSeconds: periodSeconds,
                      numPoints: numPoints
              });
      }


      function applyPathToGraph(graph, path) {
              var pathParts = path.split('/');
              var service = pathParts[0];
              var metric = pathParts[1];
              var stat = pathParts[2];

              if (pathParts.length != 3) {
                      alert('Sorry, I cant plot that path.');
                      return;
              }

              var startSeconds = graph.startSeconds;
              var endSeconds = graph.startSeconds + (graph.numPoints *
                                                     graph.periodSeconds);

              //Now to generate all the paths and to fetch all the
              // data...  First round to the nearest hour above and below...
              ssRoundedHour = startSeconds - (startSeconds % 3600);
              esRoundedHour = endSeconds - (endSeconds % 3600);

              var pathsToApply = [];

              for (var i = ssRoundedHour; i < esRoundedHour; i += 3600) {
                      var ds = (new Date(i * 1000)).toISOString();
                      var dp = getDateParts(ds);
                      var p = [ service, dp.year, dp.month, dp.day, dp.hour,
                                '' + graph.periodSeconds, metric, stat ];
                      pathsToApply.push(p);
              }

              //Data structure contention keeps us from doing this in parallel.
              fetchPathsAndApplyToGraph({
                      paths: pathsToApply,
                      graph: graph
              });
      }


      function fetchPathAndApplyToGraphFunction(path, graph) {
              return (function () {
                      getData({ path: path }, function (err, data) {
                              if (err) {
                                      console.log('Failed fetching: ' +
                                                  JSON.stringify(path));
                                      return;
                              }
                              //TODO: This join is stupid.  Refactor.
                              var obj = pathToObject(path);
                              obj.data = data;

                              applyObjToGraph(obj, graph);
                      });
              });
      }


      function fetchPathsAndApplyToGraph(opts) {
              var paths = opts.paths;
              var graph = opts.graph;

              for (var i = 0; i < paths.length; ++i) {
                      var path = paths[i];
                      var f = fetchPathAndApplyToGraphFunction(path, graph);
                      f();
              }
      }


      function applyObjToGraph(obj, graph) {
              if (graph.periodSeconds != obj.periodSeconds) {
                      alert('Graph period (' + graph.periodSeconds +
                            ') is not the same as the data period (' +
                            obj.periodSeconds + ')');
                      return;
              }

              //Determine if the obj is in range of the graph
              var graphEnd = graph.startSeconds + (graph.periodSeconds *
                                                   graph.numPoints);
              var objEnd = obj.startSeconds + (obj.periodSeconds *
                                               obj.data.length);

              var within = (obj.startSeconds >= graph.startSeconds &&
                            obj.startSeconds <= graphEnd) ||
                      (objEnd >= graph.startSeconds &&
                       objEnd <= graphEnd);
              if (!within) {
                      return;
              }

              //Remove the zero series if this is the first obj
              if (graph.zeroed) {
                      graph.series.pop();
                      graph.zeroed = false;
              }

              if (!graph.seriesMap[obj.name]) {
                      //Add a new line to the graph...
                      var newSeries = zeroSeries(obj.name,
                                                 graph.palette.color(),
                                                 obj.units, graph.startSeconds,
                                                 graph.periodSeconds,
                                                 graph.numPoints);
                      graph.series.push(newSeries);
                      graph.seriesMap[obj.name] = newSeries;
              }
              var series = graph.seriesMap[obj.name];

              var periodSeconds = graph.periodSeconds;

              //Finding the offsets into each list...
              var oo = 0;
              var go = 0;

              if (obj.startSeconds < graph.startSeconds) {
                      oo = (graph.startSeconds - obj.startSeconds) /
                              periodSeconds;
              } else {
                      go = (obj.startSeconds - graph.startSeconds) /
                              periodSeconds;
              }

              //Add the points to the graph...
              while(go < graph.numPoints && oo < obj.data.length) {
                      series.data[go].y = obj.data[oo];
                      ++go;
                      ++oo;
              }

              //Finally, render!
              graph.render();
              giveGraphLegend(graph);
      }


      function getSelectedGraph() {
              return (selectedGraph);
      }


      //Takes a path and transforms it to a workable object.
      function pathToObject(path) {
              if (path.length !== 8) {
                      console.error('Cannot change path to object: ' + path);
                      return;
              }
              var obj = {};
              // muskie/2012/11/13/00/60/latency/n
              obj.service = path[0];
              obj.year = path[1];
              obj.month = path[2];
              obj.day = path[3];
              obj.hour = path[4];
              obj.periodSeconds = path[5];
              //TODO: Clever way to get units in here?
              obj.units = path[7];
              obj.name = obj.service + '/' + path.slice(6).join('/');
              var dateString = obj.year + '-' + obj.month + '-' + obj.day +
                      'T' + obj.hour + ':00:00.000Z';
              var date = new Date(dateString);
              obj.startSeconds = date.getTime() / 1000;
              return (obj);
      }



      //--- Fun with rendering graphs

      function zeroSeries(name, color, units, start, periodSeconds, numPoints) {
              var points = [];
              for (var i = 0; i < numPoints; ++i) {
                      points.push({
                              x: start + (periodSeconds * i),
                              y: 0
                      });
              }
              return ({
                      name: name,
                      data: points,
                      color: color,
                      units: units
              });
      }


      function removeGraph(did) {
              var content = document.querySelector('#content');
              var graphdiv = document.querySelector('#' + did);
              content.removeChild(graphdiv);
      }


      function createEmptyGraph(opts) {
              var startSeconds = opts.startSeconds;
              var periodSeconds = opts.periodSeconds;
              var numPoints = opts.numPoints;

              //Create a new div and append to content...
              var did = 'graph-div-' + graphNum;
              var gid = 'graph-' + graphNum;
              var sid = 'graph-slider-' + graphNum;
              var lid = 'legend-' + graphNum;
              graphNum++;

              var gdiv = '<table border=0><tr><td rowspan=2 width="100%">' +
                      '<div id="' + gid + '"></div>' +
                      '<br>' +
                      '<div id="' + sid + '"></div>' +
                      '</td><td valign=top>' +
                      '<a href="#" class="redx" onclick=removeGraph("' + did + '")>x</a>' +
                      '</td></tr><tr><td valign=top>' +
                      '<div id="' + lid + '"></div>' +
                      '</td></tr</table>';

              var newli = document.createElement('li');
              newli.draggable = true;
              newli.innerHTML = gdiv;
              newli.id = did;
              document.querySelector('#content').appendChild(newli);

              //Make it a graph
              var palette = new Rickshaw.Color.Palette();

              var zero = zeroSeries('zero', '#ffffff', 'z',
                                    startSeconds, periodSeconds, numPoints);

              var graph = new Rickshaw.Graph({
                      element: document.querySelector('#' + gid),
                      height: 150, //Default seems to be 250
                      renderer: 'line',
                      series: [zero]
              });
              graph.render();

              //Here we add our own stuff to the graph so that we can
              // introspect for more stuff later...
              graph.palette = palette;
              graphs.push(graph);
              graph.startSeconds = startSeconds;
              graph.periodSeconds = periodSeconds;
              graph.numPoints = numPoints;
              graph.seriesMap = {};

              //Rickshaw doesn't like graphs without series.... so we create
              // a fake dataset so make it happy, then erase it later.
              graph.zeroed = true;

              var yAxis = new Rickshaw.Graph.Axis.Y({
                      graph: graph
              });
              yAxis.render();

              var xAxis = new Rickshaw.Graph.Axis.Time({
                      graph: graph
              });
              xAxis.render();

              var hoverDetail = new Rickshaw.Graph.HoverDetail({
                      graph: graph,
                      xFormatter: function (x) {
                              return (new Date(x * 1000)).toString();
                      },
                      formatter: function(series, x, y) {
                              var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
                              var date = '<span class="date">' + new Date(x * 1000).toString() + '</span>';
                              var content = swatch + series.name + ": " + parseInt(y, 10) + '&nbsp;' + series.units + '<br>' + date;
                              return (content);
                      }
              });

              var slider = new Rickshaw.Graph.RangeSlider({
                      graph: graph,
                      element: document.querySelector('#' + sid)
              });

              graph.legendid = lid;

              //We don't do this here since it is the zero set and it would
              // just be wierd to have the zero pop up unexpededly.
              //giveGraphLegend(graph);

              makeDraggable();

              return (graph);
      }


      function giveGraphLegend(graph) {
              //Need to clear it out or else funky stuff happens...
              document.querySelector('#' + graph.legendid).innerHTML = '';

              var legend = new Rickshaw.Graph.Legend( {
                      graph: graph,
                      element: document.getElementById(graph.legendid)
              } );

              var shelving = new Rickshaw.Graph.Behavior.Series.Toggle({
                      graph: graph,
                      legend: legend
              });
      }


      function makeDraggable() {
              //jquery I pulled from the sortable demo
              $(function() {
                      $('.sortable').sortable();
                      $('.handles').sortable({
                              handle: 'span'
                      });
                      $('.connected').sortable({
                              connectWith: '.connected'
                      });
                      $('.exclude').sortable({
                              items: ':not(.disabled)'
                      });
              });
      }



      //--- Fun with getting data from Manta

      function getMantaData(path, cb) {
              if (!path) {
                      alert('getData called without a path');
              }

              //Host override - we let the manowar server that served this
              // page to determine our manta host.
              var host = document.querySelector('#manta_host').value;
              if (host) {
                      path += '?host=' + host;
              }

              var signatureUrl = '/sign' + path;
              var mantaUrl = null;

              var error = function (xhr, err) {
                      var e = {};
                      if (err) {
                              e.err = err;
                      }
                      if (xhr) {
                              e.xhr = xhr
                      }
                      e.signatureUrl = signatureUrl;
                      e.mantaUrl = mantaUrl;
                      cb(e);
              }

              var successDataGet = function (data, status) {
                      cb(null, data);
              }

              var successUrlGet = function (mantaUrlGot, status) {
                      mantaUrl = mantaUrlGot;
                      $.ajax({
                              url: mantaUrl,
                              dataType: 'text',
                              success: successDataGet,
                              error: error
                      });
              }

              //Get a presigned URL from manowar
              $.ajax({
                      url: signatureUrl,
                      dataType: 'text',
                      success: successUrlGet,
                      error: error
              });
      }


      function listMantaDir(path, cb) {
              getMantaData(path, function (err, data) {
                      if (err) {
                              cb(err);
                              return;
                      }
                      if (!data) {
                              cb(null, []);
                              return;
                      }
                      var blobs = data.split('\n');
                      var dirs = [];
                      for (var i = 0; i < blobs.length; ++i) {
                              if (blobs[i] === '') {
                                      continue;
                              }
                              var dirObj = JSON.parse(blobs[i]);
                              dirs.push(dirObj);
                      }
                      cb(null, dirs);
              });
      }


      //--- Fun with the data cache

      function getData(opts, cb) {
              if (!opts.path) {
                      return (null);
              }
              var obj = getFromDataCache(opts.path);
              if (obj) {
                      cb(null, obj);
              } else {
                      getAndCache(opts, cb);
              }
      }


      function getFromDataCache(path) {
              if (path === null || dataCache === null) {
                      return (null);
              }
              var location = dataCache;
              for (var i = 0; i < path.length; ++i) {
                      if (!location[path[i]]) {
                              return (null);
                      }
                      location = location[path[i]];
              }
              return (location);
      }


      //Recursively fetches data down a path, caching along the way.
      function getAndCache(opts, cb) {
              var path = opts.path;
              var parent = opts.parent;
              var current = opts.current;
              var depth = opts.depth || 0;

              //Files are located at:
              // /$MANTA_USER/stor/graphs/data/[service]/[year]/[month]/[day]/[hour]/[period].data
              // So... parts array matches:    0         1      2       3     4      5

              //This will break if we put data in other places.  It should
              //probably be smarter and see if the above directory is 'data'
              if (!current && depth < 6) {
                      var p = mantaPrefix + path.slice(0, depth).join('/');
                      listMantaDir(p, function (err, dirs) {
                              if (err) {
                                      err.terminationDepth = depth;
                                      err.opts = opts;
                                      cb(err);
                                      return;
                              }

                              //To begin with, all is null
                              var listingObject = {};
                              for (var i = 0; i < dirs.length; ++i) {
                                      var dirObj = dirs[i];
                                      var n = dirObj.name;
                                      if (dirObj.type === 'directory') {
                                              listingObject[n] = null;
                                      } else if (dirObj.type === 'object' &&
                                                 n.endsWith('.data')) {
                                              n = n.replace('.data', '');
                                              listingObject[n] = null;
                                      }
                              }

                              //Set up the parent with a reference to what
                              // we just made... though since there could be
                              // multiple requests for the same object we need
                              // to make sure some other object didn't populate
                              // the object in our "absense"
                              if (depth === 0) {
                                      //Special case depth 0 (the cache)...
                                      if (!dataCache) {
                                              dataCache = listingObject;
                                      } else {
                                              listingObject = dataCache;
                                      }
                                      parent = dataCache;
                              } else {
                                      if (!parent[path[depth - 1]]) {
                                              parent[path[depth - 1]] = listingObject;
                                      } else {
                                              listingObject = parent[path[depth - 1]];
                                      }
                              }

                              //Base cases...
                              if (path.length === depth) {
                                      cb(null, listingObject);
                              } else if (path[depth] in listingObject) {
                                      getAndCache({
                                              path: path,
                                              parent: listingObject,
                                              current: listingObject[path[depth]],
                                              depth: depth + 1
                                      }, cb);
                              } else {
                                      cb({ terminationDepth: depth });
                              }
                      });
              } else if (!current) {
                      //Get the object from manta...
                      var p = mantaPrefix + path.slice(0, depth).join('/') + '.data';
                      getMantaData(p, function(err, data) {
                              if (err) {
                                      err.terminationDepth = depth;
                                      err.opts = opts;
                                      cb(err);
                                      return;
                              }
                              var dataObj = JSON.parse(data);
                              //Join the data into the cache...
                              parent[path[depth - 1]] = dataObj.metrics;

                              //Now that we've populated all we can, just use
                              // the "normal" method.  Ya, it walks the top again,
                              // but who cares?
                              var pathObject = getFromDataCache(path);
                              if (pathObject === null) {
                                      cb({ terminationDepth: depth });
                                      return;
                              }
                              cb(null, pathObject);
                      });
              } else {
                      getAndCache({
                              path: path,
                              parent: current,
                              current: current[path[depth + 1]],
                              depth: depth + 1
                      }, cb);
              }

      }



      //--- Fun with autocompletion

      function findLatestMetricsPath(opts, cb) {
              var service = opts.service;
              var cPath = opts.currentPath || [ service ];
              var eDepth = opts.endDepth || 6;
              var popped = opts.popped;
              var startTime = opts.startTime || (new Date()).getTime();
              var progressCallback = opts.progressCallback;

              //Progress Callback...
              if (progressCallback) {
                      progressCallback(opts);
              }

              getData({ path: cPath }, function (err, obj) {
                      if (err) {
                              cb(err);
                              return;
                      }

                      var list = [];
                      for (var d in obj) {
                              list.push(d);
                      }
                      list.sort(function (a, b) { return (b - a); });
                      var index = 0;
                      if (popped && list.indexOf(popped) > -1) {
                              index = list.indexOf(popped) + 1;
                      }

                      //If the current level has no entries, we pop off
                      // the stack and try the next one in line...
                      if (list.length > index && list[index]) {
                              cPath.push(list[index]);
                              popped = null;
                              //Base case...
                              if (cPath.length === eDepth) {
                                      cb(null, cPath);
                                      return;
                              }
                      } else {
                              popped = cPath.pop();
                              //Case where we've searched everthing and
                              // haven't gotten to the depth we expect.
                              if (cPath.length < 2) {
                                      var e = new Error('No data found');
                                      cb(e);
                                      return;
                              }
                      }
                      findLatestMetricsPath({
                              service: service,
                              currentPath: cPath,
                              endDepth: eDepth,
                              popped: popped,
                              startTime: startTime,
                              progressCallback: progressCallback
                      }, cb);
              });
      }


      function autocompletePath(request, response) {
              var term = request.term;
              var pathParts = term.split('/');
              var path = pathParts.slice(0, pathParts.length - 1);
              var current = pathParts[pathParts.length - 1];
              var pathPrefix = path.join('/') + '/';

              if (pathParts.length >= 4) {
                      response([]);
                      return;
              }

              //We hide the details of how we implement autocomplete... but
              // in manta the data is stored under:
              // /$MANTA_USER/stor/graphs/data/[service]/[year]/[month]/[day]/[hour]/[period].data
              // We want the path that people type in to be:
              // service/metric/stat
              // So we list the services when there are no path separators,
              // for the others, we trace down the latest path, pull the latest
              // data we can find and display the metrics and stats available,

              var processMetrics = function (err, obj) {
                      if (err) {
                              console.log(err);
                              response([]);
                              return;
                      }

                      var prefix = null;
                      var term = null;

                      if (pathParts.length === 1) {
                              prefix = current + '/';
                              term = '';
                      } else if (pathParts.length === 2 && obj[pathParts[1]]) {
                              prefix = pathPrefix + pathParts[1] + '/';
                              obj = obj[pathParts[1]];
                              term = '';
                      } else if (pathParts.length === 2) {
                              prefix = pathPrefix;
                              term = pathParts[1];
                      } else {
                              prefix = pathPrefix;
                              obj = obj[pathParts[1]];
                              term = pathParts[2];
                      }

                      //obj, prefix and term should be filled in by now...
                      var list = [];
                      for (var o in obj) {
                              if (o.startsWith(term)) {
                                      list.push(prefix + o);
                              }
                      }
                      response(list);
              }

              var processPath = function (err, gotPath) {
                      hideStatusDialog();
                      if (err) {
                              showStatusDialog('Couldn\'t find ' +
                                               'autocomplete data ' +
                                               'for ' + pathParts[0] +
                                               '.',
                                               true);
                              console.log(err);
                              return;
                      }
                      getData({ path: gotPath }, processMetrics);
              }

              function progressCallback(opts) {
                      //Only show if the search has gone on for
                      // more than 500 milliseconds...
                      var now = (new Date()).getTime();
                      if (opts.currentPath &&
                          (now - opts.startTime) > 500) {
                              var p = 'Searching Manta:<br>' +
                                      mantaPrefix +
                                      opts.currentPath.join('/');
                              showStatusDialog(p);
                      }
              }

              if (pathParts.length < 2) {
                      getData({ path: path }, function (err, services) {
                              if (err) {
                                      return;
                              }

                              //If we have an exact match, "fall through"
                              if (services[current] ||
                                  services[current] === null) {
                                      findLatestMetricsPath({
                                              service: pathParts[0],
                                              progressCallback: progressCallback
                                      }, processPath);
                              } else {
                                      var list = [];
                                      for (var d in services) {
                                              if (d.startsWith(current)) {
                                                      list.push(d);
                                              }
                                      }
                                      response(list);
                              }
                      });
              } else {
                      findLatestMetricsPath({
                              service: pathParts[0],
                              progressCallback: progressCallback
                      }, processPath);
              }
      }


      //Turn on autocomplete.
      $(function () {
              //Turn on autocompletion for the path
              $('#path_chooser').autocomplete({
                      minLength: 0,
                      source: autocompletePath,
                      select: function (e, ui) {
                              var val = ui.item.value;
                              var parts = val.split('/');
                              if (parts.length < 3) {
                                      //Thanks to scott.gonzalez
                                      // http://stackoverflow.com/questions/12984151/trigger-search-from-select-within-jquery-ui-autocomplete
                                      setTimeout(function() {
                                              $('#path_chooser').autocomplete('search', val);
                                      }, 1);
                              }
                      }
              });

              //Date/time choosers
              //See: http://stackoverflow.com/questions/11963621/how-to-obtain-utc-time-in-jquery-datetimepicker
              $.datepicker._gotoToday = function(id) {
                      var inst = this._getInst($(id)[0]),
                      $dp = inst.dpDiv;
                      this._base_gotoToday(id);
                      var tp_inst = this._get(inst, 'timepicker');
                      //removed -> selectLocalTimeZone(tp_inst);
                      var now = new Date();
                      var now_utc = new Date(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(),  now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds());
                      this._setTime(inst, now_utc);
                      $('.ui-datepicker-today', $dp).click();
              };

              var startDateTextBox = $('#start_date');
              var endDateTextBox = $('#end_date');

              startDateTextBox.datetimepicker({
                      controlType: 'select',
                      timeFormat: 'HH:mm',
                      onClose: function(dateText, inst) {
                              if (endDateTextBox.val() != '') {
                                      var testStartDate = startDateTextBox.datetimepicker('getDate');
                                      var testEndDate = endDateTextBox.datetimepicker('getDate');
                                      if (testStartDate > testEndDate)
                                              endDateTextBox.datetimepicker('setDate', testStartDate);
                              }
                              else {
                                      endDateTextBox.val(dateText);
                              }
                      },
                      onSelect: function (selectedDateTime){
                              endDateTextBox.datetimepicker('option', 'minDate', startDateTextBox.datetimepicker('getDate') );
                      }
              });
              endDateTextBox.datetimepicker({
                      controlType: 'select',
                      timeFormat: 'HH:mm',
                      onClose: function(dateText, inst) {
                              if (startDateTextBox.val() != '') {
                                      var testStartDate = startDateTextBox.datetimepicker('getDate');
                                      var testEndDate = endDateTextBox.datetimepicker('getDate');
                                      if (testStartDate > testEndDate)
                                              startDateTextBox.datetimepicker('setDate', testEndDate);
                              }
                              else {
                                      startDateTextBox.val(dateText);
                              }
                      },
                      onSelect: function (selectedDateTime){
                              startDateTextBox.datetimepicker('option', 'maxDate', endDateTextBox.datetimepicker('getDate') );
                      }
              });
      });



      //--- Fun with the graphit button

      function disableGraphIt() {
              var graphButton = document.querySelector('#graph_it');
              document.getElementById("graph_it").className = 'grey-graph-it';
              graphItButtonEnabled = false;
      }


      function enableGraphIt() {
              var graphButton = document.querySelector('#graph_it');
              document.getElementById("graph_it").className = 'green-graph-it';
              graphItButtonEnabled = true;
      }


      //Since the autocomplete thing is 'magic' and sometimes doesn't enable
      // the graphit button we're doing this hacky thing instead...
      $(function () {
              function testEnableGraphItButton() {
                      var timeout = 1000;
                      var val = document.querySelector('#path_chooser').value;
                      var start = document.querySelector('#start_date').value;
                      var end = document.querySelector('#end_date').value;
                      var path = val.split('/');
                      if (path.length === 3 && path[path.length - 1] !== '' &&
                          start && end && start !== end) {
                              enableGraphIt();
                      } else {
                              disableGraphIt();
                      }
                      setTimeout(testEnableGraphItButton, timeout);
              }
              testEnableGraphItButton();
      });



      //--- Fun with dialogues... I was using the JQuery UI dialog and
      // tooltips, but the tooltips weren't reappearing on show and
      // the dialog was stealing focus... so I made my own.  Sad but
      // true.

      //Increase the default animation speed to exaggerate the effect
      $.fx.speeds._default = 250;
      $(function() {
              var w = $("#header_separator")[0];
              $("#status_dialog").position({
                      my: 'right top',
                      at: 'right bottom',
                      of: w
              });
      });


      function showStatusDialog(html, closeSoon) {
              $('#status_dialog')[0].innerHTML = html;
              $('#status_dialog').slideDown();
              if (closeSoon) {
                      setTimeout(hideStatusDialog, 1500);
              }
      }


      function hideStatusDialog() {
              $('#status_dialog').slideUp();
      }



      //--- Fun with the override

      function overrideUpdated() {
              saveConfig();
              testMantaConnection();
      }


      //--- Fun with saving/restoring config

      //This really should be located with all the other global vars up top
      // but I really wanted it to be close to these two functions...
      var fieldsToSave = [
              'manta_host'
      ];


      function saveConfig() {
              var config = {};
              for (var i = 0; i < fieldsToSave.length; ++i) {
                      var key = fieldsToSave[i];
                      var value = document.querySelector('#' + key).value;
                      config[key] = value;
              }
              var cs = JSON.stringify(config);
              localStorage['config'] = cs;
      }


      function loadConfig(cb) {
              function gotError(xhr, err) {
                      showStatusDialog('Error fetching config from server.');
                      cb(err);
              }

              function gotConfig(configString, status) {
                      var c = JSON.parse(configString);

                      //Figure out the prefix from the user the server
                      // is serving up.
                      mantaPrefix = '/' + c.user + dataPath;

                      //Loal user config from localstorage...
                      if (!localStorage['config']) {
                              return;
                      }
                      var cs = localStorage['config'];
                      var config = JSON.parse(cs);
                      for (var key in config) {
                              document.querySelector('#' + key).value =
                                      config[key];
                      }
                      cb(null);
              }

              //Load config from server...
              $.ajax({
                      url: '/config',
                      dataType: 'text',
                      success: gotConfig,
                      error: gotError
              });

      }


      function testMantaConnection(cb) {
              showStatusDialog('\
      <table border=0 width=100%><tr> \
        <td>Testing manta connection...</td> \
        <td align=right><img src="css/images/ui-anim_basic_16x16.gif"></td> \
      </tr></table> \
      ');
              getMantaData(mantaPrefix, function (err) {
                      if (err) {
                              var m = '';
                              if (err.mantaUrl) {
                                      var host = err.mantaUrl.split('/')[2];
                                      m = ' \
      Looks like we can\'t currently get data from Manta.<br> \
      <p>Troubleshooting: \
      <ul> \
        <li>Click <a href="' + err.mantaUrl + '">here</a> to see if your \
            browser can make the request.</li> \
        <li>If clicking the above link caused you to be asked to trust a self \
            signed cert and you did, you probably just solved your own \
            problem. Try again.</li> \
        <li>Is <code>' + host + '</code> the right Manta Endpoint?  If not use \
            the box above to provide an override and try again.</li> \
      </ul> \
      <a href=\'#\' onclick=\'testMantaConnection()\'>Try Connecting Again</a> \
      </p> \
      ';
                              } else {
                                      m = ' \
      Looks like the Man O\' War server is down. \
      ';
                              }
                              showStatusDialog(m);
                              if (cb) {
                                      cb(err);
                              }
                      } else {
                              var m = 'Connected to Manta!';
                              showStatusDialog(m, true);
                              if (cb) {
                                      cb();
                              }
                      }

              });
      }


      //--- Fun with saving/restoring dashboards!

      function getCurrentDashboard() {
              var dashboard = [];
              for (var i in graphs) {
                      var cg = graphs[i];
                      var paths = [];
                      for (var j in cg.seriesMap) {
                              paths.push(j);
                      }
                      var current = {
                              startSeconds: cg.startSeconds,
                              periodSeconds: cg.periodSeconds,
                              numPoints: cg.numPoints,
                              paths: paths
                      };
                      dashboard.push(current);
              }
              return dashboard;
      }

      function restoreDashboard(dashboard) {
              for (var gn in dashboard) {
                      var g = dashboard[gn];
                      var graph = newGraph({
                              startSeconds: g.startSeconds,
                              periodSeconds: g.periodSeconds,
                              numPoints: g.numPoints
                      });

                      for (var u in g.paths) {
                              var path = g.paths[u];
                              applyPathToGraph(graph, path);
                      }
              }
      }



      //--- Fun with giving out dashboards to your friends

      function loadUrlGraph() {
              var qs = getQueryString();
              if (qs.dashboard === undefined) {
                      return;
              }
              try {
                      var def = JSON.parse(qs.dashboard);
                      restoreDashboard(def);
              } catch (e) {
                      alert(qs.dashboard + ' isn\'t a valid dashboard ' +
                            'definition.');
              }
      }


      function displayCurrentGraphLink() {
              var dashObj = getCurrentDashboard();
              if (dashObj.length < 1) {
                      alert('Please make a dashboard first.');
                      return;
              }

              var dashboard = encodeURIComponent(JSON.stringify(dashObj));

              var before_query = window.location.toString().split('?')[0];

              var url = before_query + '?dashboard=' + dashboard;
              $(function() {
                      $( "#url_dialog" ).dialog({
                              modal: true
                      });
              });
              document.getElementById('url_dialog').innerHTML = ' \
      Link to this dashboard:<br> \
      <input type="text" id="url_text" value="' + url + '"> \
      ';
              document.getElementById('url_text').focus();
              document.getElementById('url_text').select();
      }



      //--- Onload

      $(document).ready(function () {
              loadConfig(function () {
                      testMantaConnection(function (err) {
                              if (!err) {
                                      loadUrlGraph();
                              }
                      });
              });
      });
    </script>
  </head>
  <body>
    <table width="100%" border="0" id="header_table">
      <tr>
        <td align="left">Man O' War</td>
        <td align="center">
          Path: <input type="text" id="path_chooser" name="path_chooser" size="100" />
          Start: <input type="text" id="start_date" size="17" />
          End: <input type="text" id="end_date" size="17" />
          <a href="#" id="graph_it" class="green-graph-it"
             onclick="if (graphItButtonEnabled) { addLineFromPathChooser(); }">Graph It!</a>
        </td>
        <td align="right">
          Manta Host Override:
          <input type="text" id="manta_host" name="manta_host"
                 onchange="overrideUpdated()" size="15">
          <div id="message_dialog" /></div>
          <div id="url_dialog" /></div>
        </td>
      </tr>
    </table>
    <hr id="header_separator">
    <a href="#" id="graph_it" class="green-graph-it" onclick="displayCurrentGraphLink()">Get Link</a><br>
    <div id="status_dialog"></div>

    <ul id="content" class="sortable list"></ul>
  </body>
</html>
